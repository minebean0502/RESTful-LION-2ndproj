<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>호텔 예약 페이지</title>
    <!-- 이모티콘 사용 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script type="text/javascript"
            th:src="@{https://oapi.map.naver.com/openapi/v3/maps.js(ncpClientId=${clientId})}"></script>
    <link rel="stylesheet" href="/static/css/search-container.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
        }

        .container {
            display: flex;
            align-items: center;
            justify-content: center;
            /* 각 컨테이너의 높이를 자동으로 조정 */
            height: auto;
        }

        .tour-info-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            justify-content: center;
            width: 100%;
            margin: auto;
            overflow: hidden; /* 컨테이너에서 벗어나는 내용을 숨김 */
        }

        .hotel-info, .room-info, .location-info, .review-info, .contact-info, review-info {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            display: flex;
            max-width: 700px;
            width: 100%;
            /* 간격을 좁힘 */
            margin-bottom: 20px;
        }

        .tour-info {
            overflow: hidden; /* 가로 스크롤 부분에서 벗어나는 내용을 숨김 */
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            display: flex;
            max-width: 700px;
            width: 100%;
            /* 간격을 좁힘 */
            margin-bottom: 20px;
        }

        .hotel-image {
            flex: 0 0 40%;
            margin-right: 30px;
        }

        .hotel-image img {
            width: 100%;
            border-radius: 10px;
        }

        .hotel-details, .room-details {
            flex: 0 0 60%;
        }

        .hotel-details h2, .room-details h2 {
            margin-top: 0;
            font-size: 24px;
            color: #333;
        }

        .hotel-details p, .room-details p {
            margin: 10px 0;
            font-size: 16px;
            color: #666;
        }

        .rating {
            display: flex;
            align-items: center;
            color: #f39c12;
        }

        .rating .fa-star {
            font-size: 20px;
        }

        .rating span {
            margin-left: 5px;
        }

        /* 호텔과 방 사이의 간격 */
        .space {
            margin-bottom: 20px;
        }

        /* 주변 관광지 */
        .horizontal-scroll {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            margin-left: -30px; /* 첫 번째 요소의 왼쪽 여백 조정 */
            padding-left: 30px; /* 스크롤 영역의 시작 부분에 패딩 추가 */
            padding-right: 30px;
            white-space: nowrap;
            width: 700px;
            align-items: center;
        }

        .tour-item {
            flex: 0 0 auto;
            display: inline-block;
            width: 200px; /* 너비 조정 가능 */
            height: 170px;
            margin-right: 15px;
            vertical-align: top;
            background: #f4f4f4; /* 배경 색상 */
            border-radius: 8px; /* 모서리 둥글게 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* 그림자 효과 */
            white-space: normal;
        }

        .tour-item.selected {
            background-color: #e0e0e0; /* 선택 시 배경색 변경 */
        }

        .tour-item img {
            width: 100%; /* 이미지 너비 */
            height: 100px; /* 이미지 높이 조정 */
            object-fit: cover; /* 이미지 비율 유지 */
            border-radius: 8px 8px 0 0;
            margin-bottom: 6px;
        }

        .tour-item h3, .tour-item p {
            padding: 6px 8px; /* 내부 여백 */
            margin: 0; /* 외부 여백 제거 */
        }

        .tour-item h3 {
            font-size: 14px; /* 제목 글자 크기 */
            color: #333; /* 제목 글자 색상 */
        }

        .tour-item p {
            font-size: 11px; /* 내용 글자 크기 */
            color: #666; /* 내용 글자 색상 */
            word-break: keep-all;
        }

        .load-more-container {
            display: inline-block;
            padding: 8px 12px;
            height: auto; /* 버튼의 높이 자동 조절 */
        }

        .load-more {
            /*padding: 10px 20px;*/
            background: #333;
            color: white;
            border: none;
            cursor: pointer;
            height: 170px;
            border-radius: 8px; /* 모서리 둥글게 */
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        /* 입력란 */
        input[type="text"],
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        /* 제출 버튼*/
        button[type="submit"] {
            padding: 10px 20px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button[type="submit"]:hover {
            background-color: #0056b3;
        }

        /*    리뷰    */
        h3 {
            text-align: center;
        }

        .left-align-container {
            text-align: left;
            margin: 0px;
        }

        p {
            margin-top: 0;
            margin-bottom: 0rem;
        }

        .container {
            width: 80%;
            margin: 20px auto;
        }

        textarea, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 5px;
        }

        button {
            padding: 10px 20px;
            cursor: pointer;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 8px;
            border: 1px solid #ccc;
            text-align: left;
        }

        .star-rating {
            display: flex;
            flex-direction: row-reverse;
            justify-content: flex-end;
        }

        .star-rating input {
            display: none;
        }

        .star-rating label {
            font-size: 30px;
            padding: 5px;
            color: #ccc;
            cursor: pointer;
        }

        .star-rating input:checked ~ label,
        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: #f90;
        }

        .stars-inner {
            font-size: 20px;
            color: #f90;
        }


        hr {
            width: 49%;
        }

        .center-hr {
            margin-left: auto;
            margin-right: auto;
        }

        .review-info {
            background-color: #fff;
            padding: 10px;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            display: flex;
            max-width: 700px;
            width: 100%;
            /* 간격을 좁힘 */
            margin-bottom: 20px;
        }


        /* 문의 */
        .inquiry-info {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            flex-direction: column;
            max-width: 700px;
            width: 100%;
            margin-bottom: 20px;
        }

        .inquiry-info button {
            width: auto;
            padding: 5px 10px;
            align-self: flex-start;
        }

        .inquiry-info table, .inquiry-info th, .inquiry-info td {
            border: none;
        }

        .inquiry-info .btn-dark {
            background: #555;
            color: #fff;
        }

        .inquiry-info .btn-reply {
            display: inline-block;
            padding: 0 10px;
            font-size: 10px;
            font-weight: 300;
            text-align: center;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.3s;
            width: 70px;
        }

        .inquiry-info .btn-dark:hover, .btn-dark:focus {
            background: #373737;
            border-color: #373737;
            color: #fff;
        }

        .inquiry-info .reply-input, .btn-reply {
            height: 40px; /* 높이 설정 */
            line-height: 40px; /* 세로 중앙 정렬을 위해 line-height도 맞춤 */
            vertical-align: middle;
            margin-top: 10px;
        }

        .inquiry-info .reply-input {
            width: 80%;
        }

        .inquiry-info .pagination-btn {
            padding: 5px 5px;
            font-size: 16px;
            color: #333;
            background-color: transparent;
            border: 1px solid #ccc;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .inquiry-info .pagination-btn:hover {
            color: #fff;
            background-color: #555;
            border-color: #555;
        }

        .inquiry-info .pagination-btn:disabled {
            color: #ccc;
            background-color: #f8f8f8;
            cursor: not-allowed;
            border-color: #eee;
        }

        .inquiry-info .hidden-content {
            display: none;
            background-color: #f9f9f9;
            padding: 10px;
            font-size: 12px;
        }

        .inquiry-info .icon-button {
            color: #555;
            cursor: pointer;
            padding: 5px;
            font-size: 10px;
        }

        .inquiry-info .action-icons {
            margin-left: 10px;
        }

        .room-info h2 {
            margin-bottom: 20px;
            font-size: 24px;
            color: #333;
        }
        .card-title {
            font-size: 1.25rem; /* 제목 폰트 크기 */
            font-weight: bold; /* 제목 글꼴 두껍게 설정 */
            color: #333; /* 제목 색상 */
            margin-bottom: 10px; /* 아래 여백 설정 */
        }

        .card-text {
            font-size: 1rem; /* 텍스트 폰트 크기 */
            color: #666; /* 텍스트 색상 */
            margin-bottom: 10px; /* 아래 여백 설정 */
        }

        .card-price {
            font-size: 1.1rem; /* 가격 폰트 크기 */
            font-weight: bold; /* 가격 글꼴 두껍게 설정 */
            color: #007bff; /* 가격 색상 */
            margin-bottom: 10px; /* 아래 여백 설정 */
        }

        .btn-primary {
            background-color: #007bff; /* 버튼 배경색 */
            color: #fff; /* 버튼 텍스트 색상 */
            border: none; /* 버튼 테두리 없음 */
            border-radius: 5px; /* 버튼 모서리 둥글게 설정 */
            padding: 10px 20px; /* 버튼 안 여백 설정 */
            cursor: pointer; /* 커서 모양 변경 */
            transition: background-color 0.3s ease; /* 배경색 전환 애니메이션 */
        }

        .btn-primary:hover {
            background-color: #0056b3; /* 마우스 호버시 배경색 변경 */
        }
    </style>
</head>
<body>

<header>
    <th:block th:replace="~{updown/header}"></th:block>
</header>

<aside class="search-container">
    <div class="search-bar">
        <input type="date" id="checkInDate">
        <input type="date" id="checkOutDate">
        <button onclick="searchButtonClick()">Search</button>
    </div>
</aside>

<!-- 호텔 -->
<div class="container">
    <div class="hotel-info">
        <div class="hotel-image">
            <!-- 호텔 이미지 삽입 필요 -->
            <img src="" alt="Hotel Image" id="hotelImage">
        </div>
        <div class="hotel-details">
            <h2 id="hotelName">호텔 이름</h2>
            <p id="hotelAddress"><i class="fas fa-map-marker-alt"></i> address</p>
            <p id="hotelTel"><i class="fas fa-phone"></i> tel</p>
            <!-- 별점 표시 조건 로직 필요(js) -->
            <div class="rating">
                <div id="ratingStars">

                </div>
                <!-- 별점 데이터 삽입 -->
                <span id="ratingScore">(별점 데이터)/5</span>
            </div>
        </div>
    </div>
</div>

<!-- 간격 추가 -->
<div class="space"></div>

<!-- 객실 정보 -->
<div class="container">
    <div class="room-info">
        <div style="width: 100%">
            <h2>객실 정보</h2>
            <div class="row" id="roomList">
                <!-- 객실 정보가 들어갈 곳 -->
            </div>
        </div>
    </div>
</div>

<!-- 간격 추가 -->
<div class="space"></div>

<!-- 위치 -->
<div class="container">
    <div class="location-info" style="display: block">
        <h2>위치 정보</h2>
        <!-- 지도 -->
        <div id="map" style="width:100%;height:400px;"></div>
    </div>
</div>

<!-- 간격 추가 -->
<div class="space"></div>

<!-- 주변 여행지 -->
<div class="tour-info-container">
    <div class="tour-info">
        <div class="tour-details">
            <h2>주변 여행지</h2>
            <ul id="tourList" class="horizontal-scroll">
                <!-- 관광지 정보가 들어갈 곳 -->
                <li class="load-more-container">
                    <button id="loadMore" class="load-more">&raquo;</button>
                </li>
            </ul>
        </div>
    </div>
</div>

<!-- 간격 추가 -->
<div class="space"></div>

<section class="reviews" id="reviews">
    <hr class='center-hr'/>
    <div class="container">
        <h3>리뷰 작성하기</h3>
    </div>
    <div class="container">
        <div style="width: 60%; margin: auto;">
            <textarea id="reviewContent" class="form-control" placeholder="리뷰를 작성해주세요."></textarea>
        </div>
    </div>
    <div class="container">
        <p style="text-align: left; padding-left:10px; padding-top: 5px;" class="text-bold">별점을 선택해주세요.</p>
    </div>
    <!-- 간격 추가 -->
    <div class="space"></div>
    <div class="container">
        <div class="star-rating">
            <input type="radio" id="star5" name="rating" value="5"/><label for="star5">★</label>
            <input type="radio" id="star4" name="rating" value="4"/><label for="star4">★</label>
            <input type="radio" id="star3" name="rating" value="3"/><label for="star3">★</label>
            <input type="radio" id="star2" name="rating" value="2"/><label for="star2">★</label>
            <input type="radio" id="star1" name="rating" value="1"/><label for="star1">★</label>
        </div>
    </div>
    <div class="container">
        <div class="left-align-container">
            <button onclick="submitReview()" class="btn btn-primary btn-sm">등록하기</button>
        </div>
    </div>
    <br>
    <hr class='center-hr'/>
    <!-- 간격 추가 -->
    <div class="space"></div>
    <h3>리뷰 리스트</h3>
    <br>
    <div class="container">
        <div class="review-info">
            <table id="reviewsTable" class="table table-borderless" style="width: 130%; margin: 5px auto;">
                <thead>
                <tr>
                    <th>작성자</th>
                    <th>내용</th>
                    <th>별점</th>
                    <th>수정/삭제</th>
                </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>
    </div>
    <br>
    <br>
</section>

<!--<th:block th:replace="~{updown/footer}"></th:block>-->
<!--<div id="footer">-->
<!--    <th:block th:replace="~{updown/footer}"></th:block>-->
<!--</div>-->


<!-- 문의 -->
<div id="inquiry">
    <div class="container">
        <div class="inquiry-info" id="inquiries">
            <h2>문의 사항</h2>
            <button type="submit" class="btn btn-primary btn-sm" onclick="openSubmitForm()">질문등록</button>
            <table class="board-table">
                <thead>
                <tr>
                    <th class="th-num">답변상태</th>
                    <th class="th-title">제목</th>
                    <th class="th-author">작성자</th>
                    <th class="th-date">등록일</th>
                </tr>
                </thead>
                <tbody>

                </tbody>
            </table>

            <!-- pagination area-->
            <div id="pagination">
            </div>
        </div>
    </div>
</div>

<!--<th:block th:replace="~{updown/footer}"></th:block>-->
<div id="footer">
    <th:block th:replace="~{updown/footer}"></th:block>
</div>

<script>
    window.addEventListener('message', function (event) {
        if (event.origin !== "http://localhost:8080") {
            return;
        }
        if (event.data === 'paymentContinueSuccess') {
            window.location.href = "/my-page";
        } else if (event.data === 'paymentContinueFailure') {
            window.location.reload();
        }
    }, false);

    const hotelId = [[${hotelId}]];
    console.log(hotelId)
    const checkIn = `[[${checkIn}]]`;
    const checkOut = `[[${checkOut}]]`;

    let mapX;
    let mapY;

    const pin_icon = {
        url: '/static/map/pin_icon.png',
        size: new naver.maps.Size(30, 30),
        scaledSize: new naver.maps.Size(30, 30)
    }

    const pin_icon_selected = {
        url: '/static/map/pin_icon_selected.png',
        size: new naver.maps.Size(30, 30),
        scaledSize: new naver.maps.Size(30, 30)
    }

    async function fetchHotelInfo() {
        const url = encodeURI(`/api/hotel/search/${hotelId}?checkIn=${checkIn}&checkOut=${checkOut}`);
        const response = await fetch(url);
        const data = await response.json();
        if (response.ok) {
            var img;
            if (data.firstImage === "") img = "/static/replace/replace_img.png"; // 대체사진 선정
            else img = `${data.firstImage}`;

            document.getElementById('hotelName').innerText = data.title;
            document.getElementById('hotelImage').src = img;
            document.getElementById('hotelAddress').innerText = data.address;
            document.getElementById('hotelTel').innerText = data.tel;

            mapX = data.mapX;
            mapY = data.mapY;

            const hotelRating = data.avg_score;
            const ratingStars = document.getElementById('ratingStars');

            let cnt = 0;
            for (let i = 0; i < Math.round(hotelRating); i++) {
                const fullStar = document.createElement('i');
                fullStar.className = 'fas fa-star';
                ratingStars.appendChild(fullStar);
                cnt++;
            }
            for (let i = 0; i < 5 - cnt; i++) {
                const emptyStar = document.createElement('i');
                emptyStar.className = 'far fa-star';
                ratingStars.appendChild(emptyStar);
            }
            document.getElementById('ratingScore').innerText = hotelRating.toFixed(2);

            const roomUl = document.getElementById('roomList');
            roomUl.innerHTML = ''; // 이전에 생성된 방 목록 초기화
            data.rooms.forEach(room => {
                const roomCard = createRoomCard(room);
                roomUl.appendChild(roomCard);
            });

            displayMap(data.mapX, data.mapY);
        } else {
            console.log(data);
            alert('호텔 정보를 찾을 수 없습니다.');
            history.back();
        }
    }

    // 방 목록을 카드 형식으로 생성하는 함수
    function createRoomCard(room) {
        const cardCol = document.createElement('div');
        cardCol.classList.add('col-md-4', 'mb-4');

        const card = document.createElement('div');
        card.classList.add('card');

        const cardBody = document.createElement('div');
        cardBody.classList.add('card-body');

        const roomName = document.createElement('h5');
        roomName.classList.add('card-title');
        roomName.innerText = room.name;

        const roomContent = document.createElement('p');
        roomContent.classList.add('card-text');
        roomContent.innerText = room.content;

        const roomPrice = document.createElement('p');
        roomPrice.classList.add('card-text');
        roomPrice.innerText = '가격: ' + room.price;

        const paymentBtn = document.createElement('button');
        paymentBtn.classList.add('btn', 'btn-primary');
        paymentBtn.textContent = '예약 하기';
        paymentBtn.onclick = async function () {
            try {
                // 1. 예약 부분
                const reservationId = await doReservation(room.id, checkIn, checkOut);
                // 2. 결제 관련 function 시작
                doPaymentWindow(reservationId, room.id, room.name, room.price);
                alert("결제 처리가 끝났습니다.");
                window.location.reload()
            } catch (error) {
                alert("결제 처리 중 오류가 발생했습니다: " + error.message);
            }
        }

        cardBody.appendChild(roomName);
        cardBody.appendChild(roomContent);
        cardBody.appendChild(roomPrice);
        cardBody.appendChild(paymentBtn);
        card.appendChild(cardBody);
        cardCol.appendChild(card);

        return cardCol;
    }

    // 방 목록을 표시하는 함수
    function displayRoomList(rooms) {
        const roomList = document.getElementById('roomList');
        roomList.innerHTML = ''; // 이전에 생성된 방 목록 초기화

        rooms.forEach(room => {
            const roomCard = createRoomCard(room);
            roomList.appendChild(roomCard);
        });
    }

    var map;
    var mainPosition; // 호텔 좌표

    function displayMap(mapX, mapY) {
        var mapOptions = {
            center: new naver.maps.LatLng(mapY, mapX),
            zoom: 15
        };

        map = new naver.maps.Map('map', mapOptions);

        // 마커 생성
        mainPosition = new naver.maps.LatLng(mapY, mapX);
        var marker = new naver.maps.Marker({
            position: mainPosition,
            map: map
        });
    }

    // 주변 관광지 fetch
    let pageNum = 0; // 초기 페이지 0, 메소드 실행시마다 +1
    var markers = []; // 주변 관광지들 마커 담을 배열

    function loadTourInfo() {
        pageNum++;  // 다음 페이지 번호 증가

        fetch(`/api/hotel/location?mapX=${mapX}&mapY=${mapY}&pageNum=${pageNum}`)
            .then(response => response.json())
            .then(data => {
                const tourList = document.querySelector('.horizontal-scroll');

                // 더보기 버튼 임시 삭제
                const loadMoreContainer = document.querySelector('.load-more-container');
                tourList.removeChild(loadMoreContainer);

                data.forEach(tour => {
                    const li = document.createElement('li');
                    li.className = 'tour-item';

                    // 대체사진 선정
                    var img;
                    if (tour.firstImage === "") {
                        img = "/static/replace/replace_img.png";
                    } else {
                        img = `${tour.firstImage}`;
                    }

                    li.innerHTML = `
                            <img src="${img}" alt="Image of ${tour.title}">
                            <h3>${tour.title}</h3>
                            <p>${tour.address}</p>
                        `;

                    // 지도에 마커 생성
                    var position = new naver.maps.LatLng(tour.mapY, tour.mapX);
                    var markerOptions = {
                        position: position,
                        map: map,
                        icon: pin_icon
                    };
                    var marker = new naver.maps.Marker(markerOptions);
                    markers.push(marker);

                    // 클릭 시 지도 이동 EventListener 추가
                    li.addEventListener('click', () => {
                        // 우선 모든 마커를 기본 마커로 변경
                        markers.forEach(marker => {
                            marker.setIcon(pin_icon);
                        });
                        marker.setIcon(pin_icon_selected); // 해당 관광지 마커를 선택 마커로 변경
                        map.setCenter(position); // 해당 관광지를 맵의 중심으로
                    });

                    tourList.appendChild(li);
                });
                // 맨 끝에 더보기 버튼 추가
                tourList.appendChild(loadMoreContainer);
            })
            .catch(error => console.error('주변 관광지를 불러올 수 없습니다.:', error));
    }

    // tour-item 선택 이벤트 처리
    document.addEventListener('DOMContentLoaded', () => {
        const tourList = document.querySelector('.horizontal-scroll');

        tourList.addEventListener('click', (event) => {
            let targetElement = event.target.closest('.tour-item');
            if (!targetElement) return; // 클릭된 요소가 .tour-item이 아니라면 무시

            // 선택된 요소가 이미 selected 클래스를 가지고 있다면, 클래스를 제거
            if (targetElement.classList.contains('selected')) {
                targetElement.classList.remove('selected');
                markers.forEach(marker => {
                    marker.setIcon(pin_icon); // 호텔을 제외한 모든 마커를 기본 마커로
                });
                map.setCenter(mainPosition); // 다 선택 풀리면 다시 호텔을 가운데로
            } else {
                // 모든 아이템에서 selected 클래스 제거
                document.querySelectorAll('.tour-item.selected').forEach(item => {
                    item.classList.remove('selected');
                });
                // 현재 클릭된 아이템에 selected 클래스 추가
                targetElement.classList.add('selected');
            }
        });
    });

    // 더 보기 버튼 이벤트 핸들러
    document.getElementById('loadMore').addEventListener('click', loadTourInfo);

    // 리뷰
    async function submitReview() {
        const content = document.getElementById('reviewContent').value;
        const score = document.querySelector('input[name="rating"]:checked').value;
        const response = await fetch(`/api/${hotelId}/review`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({content, score})
        });

        if (response.ok) {
            alert('리뷰가 성공적으로 작성되었습니다.');
            await fetchReviews();
        } else {
            alert('리뷰 작성에 실패했습니다.');
        }
    }

    async function fetchReviews() {
        const response = await fetch(`/api/${hotelId}/review/list`);
        if (response.ok) {
            const reviews = await response.json();
            const tableBody = document.getElementById('reviewsTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';

            reviews.forEach(review => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = review.nickname;
                row.insertCell(1).textContent = review.content;
                const starCell = row.insertCell(2);
                starCell.innerHTML = createStars(review.score);
                const actionCell = row.insertCell(3);
                const editButton = document.createElement('button');
                editButton.textContent = 'Edit';
                editButton.className = 'btn btn-outline-primary btn-sm';
                editButton.style.marginRight = "10px";
                editButton.addEventListener('click', () => editReview(review.id));
                actionCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'btn btn-outline-danger btn-sm';
                deleteButton.addEventListener('click', () => deleteReview(review.id));
                actionCell.appendChild(deleteButton);

            });
        } else {
            console.error('리뷰 불러오기에 실패하였습니다.');
        }
    }

    function createStars(score) {
        let starsHtml = '';
        for (let i = 1; i <= 5; i++) {
            starsHtml += `<span class="fa fa-star ${i <= score ? 'filled' : ''}" style="color: ${i <= score ? '#f90' : '#ccc'};"></span>`;
        }
        return starsHtml;
    }

    // 별점 선택기 생성 함수
    function createStarRating(currentScore) {
        const container = document.createElement('div');
        container.className = 'star-rating';
        container.style.display = 'flex';
        container.style.flexDirection = 'row'; // 별을 왼쪽에서 오른쪽으로 배열
        container.style.justifyContent = 'flex-start';

        for (let i = 1; i <= 5; i++) {
            const input = document.createElement('input');
            input.type = 'radio';
            input.id = 'editStar' + i;
            input.name = 'editRating';
            input.value = i;

            const label = document.createElement('label');
            label.htmlFor = 'editStar' + i;
            label.textContent = '★';
            label.style.cursor = 'pointer';
            label.style.color = (i <= currentScore) ? '#f90' : '#ccc'; // 왼쪽부터 currentScore까지 색상 채우기

            input.addEventListener('change', function () {
                updateStarDisplay(this.value);
            });

            container.appendChild(input);
            container.appendChild(label);
        }

        return container;
    }

    // 별점 표시 업데이트 함수
    function updateStarDisplay(selectedScore) {
        const stars = document.querySelectorAll('.edit-form-container .star-rating label');
        stars.forEach((star, index) => {
            star.style.color = (index < selectedScore) ? '#f90' : '#ccc';
        });
    }

    async function editReview(reviewId) {
        const response = await fetch(`/api/${hotelId}/review/${reviewId}`);
        const review = await response.json();

        if (response.ok) {
            const reviewContent = document.createElement('textarea');
            // reviewContent.value = review.content; // 기존 리뷰 내용
            reviewContent.placeholder = '수정할 내용을 작성해주세요.';
            reviewContent.className = 'form-control';

            const starContainer = createStarRating(review.score); // 별점 선택기 생성

            const submitButton = document.createElement('button');
            submitButton.textContent = '수정 완료';
            submitButton.className = 'btn btn-outline-primary btn-sm';
            submitButton.onclick = async () => {
                const selectedScore = document.querySelector('input[name="editRating"]:checked').value;
                await updateReview(reviewId, reviewContent.value, selectedScore);
            };
            // // 이벤트 리스너 추가
            // submitButton.addEventListener('click', async () => {
            //     const selectedScore = document.querySelector('input[name="editRating"]:checked').value;
            //     await updateReview(reviewId, reviewContent.value, selectedScore);
            // });

            // 폼 컨테이너 생성 및 추가
            const formContainer = document.createElement('div');

            formContainer.style.width = '50%'; // 폼의 너비 설정
            formContainer.style.padding = '20px'; // 내부 패딩 설정
            formContainer.style.margin = 'auto'; // 중앙 정렬
            formContainer.style.marginBottom = '50px';
            formContainer.style.border = '1px solid #ccc'; // 테두리 설정
            formContainer.style.borderRadius = '8px'; // 테두리 둥글게 설정
            formContainer.style.backgroundColor = '#f8f8f8'; // 배경색 설정

            formContainer.className = 'edit-form-container';
            formContainer.appendChild(reviewContent);
            formContainer.appendChild(starContainer);
            formContainer.appendChild(submitButton);

            // 이전에 생성된 수정 폼이 있다면 제거
            const existingForm = document.getElementById('editForm');
            if (existingForm) existingForm.remove();

            // 새로운 폼 추가
            document.body.appendChild(formContainer);
            formContainer.id = 'editForm';

            const footer = document.getElementById('footer');
            const inquiry = document.getElementById('inquiry');
            if (footer) {
                // footer 요소의 바로 앞에 폼 삽입
                footer.parentNode.insertBefore(formContainer, footer);
                inquiry.parentNode.insertBefore(formContainer, inquiry)
            }

            // 버튼 클릭 시 폼 생성 및 삽입
            const addButton = document.getElementById('addFormButton');
            addButton.addEventListener('click', editReview);

        } else {
            alert('리뷰 정보를 불러오는 데 실패했습니다.');
        }
    }

    async function updateReview(reviewId, content, score) {
        const response = await fetch(`/api/${hotelId}/review/${reviewId}/update`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({content, score})
        });

        if (response.ok) {
            alert('리뷰가 성공적으로 수정되었습니다.');
            await fetchReviews(); // 목록을 새로고침
            const formContainer = document.getElementById('editForm');
            if (formContainer) {
                formContainer.parentNode.removeChild(formContainer); // 폼 제거
            }
        } else {
            alert('리뷰 수정에 실패했습니다.');
        }
    }


    async function deleteReview(reviewId) {
        if (confirm('리뷰를 정말 지우시겠습니까?')) {
            const response = await fetch(`/api/${hotelId}/review/${reviewId}/delete`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('리뷰가 성공적으로 지워졌습니다.');
                await fetchReviews();
            } else {
                alert('리뷰를 삭제하지 못하였습니다.');
            }
        }
    }


    function doPaymentWindow(reservationId, roomId, roomName, roomPrice) {
        // 호텔의 id, 체크인, 체크아웃으로 시작이기는 하는데
        // 룸id, 룸price, 룸name 이정도만 전달해줘도 될듯? (orderName, price만 필요하니까)
        var url = `/hotel/payment/start?reservationId=${reservationId}&roomId=${roomId}&roomName=${encodeURIComponent(roomName)}&roomPrice=${roomPrice}`
        window.open(url, 'doPaymentWindow', 'width=600, height=800');
    }

    async function doReservation(roomId, checkIn, checkOut) {
        let reservationId = null;
        try {
            const response = await fetch(`/api/hotel/reservation`, {
                method: 'post',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    roomId: roomId,
                    checkIn: checkIn,
                    checkOut: checkOut,
                }),
            });
            if (!response.ok) {
                alert('로그인을 하세요')
                throw new Error('예약 요청 실패: ' + response.statusText);
            }
            // 서버로부터의 응답을 JSON 형태로 변환합니다.
            const reservationData = await response.json();
            alert('예약이 성공적으로 완료되었습니다.');
            reservationId = reservationData.id;
        } catch (err) {
            alert(`error메세지는 다음과 같습니다: ` + err);
        }
        return reservationId;
    }

    function fillSearchParams() {
        document.getElementById('checkInDate').value = checkIn;
        document.getElementById('checkOutDate').value = checkOut;
    }

    function searchButtonClick() {
        const newCheckIn = document.getElementById('checkInDate').value;
        const newCheckOut = document.getElementById('checkOutDate').value;
        location.href = encodeURI(`/hotel/${hotelId}?checkIn=${newCheckIn}&checkOut=${newCheckOut}`);
    }

    // 문의
    let currentPage = 0;
    let currentUser = null;

    async function fetchLoginInfo() {
        const response = await fetch('/api/auth/login-info');
        if (response.ok) {
            currentUser = await response.json();
            console.log("Logged in user info:", currentUser);
        } else {
            console.error("Failed to fetch login info");
        }
    }

    async function fetchInquiries(page = 0, size = 10) {
        await fetchLoginInfo();
        currentPage = page;
        const response = await fetch(`/api/hotel/inquiries/${hotelId}?page=${page}&size=${size}`);

        if (response.ok) {
            const inquiries = await response.json();
            updatePaginationControls(inquiries);
            updateTable(inquiries);

            const inquiriesTableBody = document.querySelector('#inquiries tbody');
            inquiriesTableBody.innerHTML = ''; // 이전 데이터 삭제

            inquiries.content.forEach(inquiries => {
                const row = inquiriesTableBody.insertRow();
                const statusCell = row.insertCell(0);
                const titleCell = row.insertCell(1);
                const authorCell = row.insertCell(2)
                const createdAtCell = row.insertCell(3);

                statusCell.textContent = inquiries.comment ? '답변완료' : '미답변';
                titleCell.textContent = inquiries.title;
                titleCell.style.cursor = 'pointer'; // Make it look clickable
                authorCell.textContent = inquiries.writer;
                createdAtCell.textContent = new Date(inquiries.createdAt).toLocaleDateString();

                titleCell.addEventListener('click', function () {
                    const input = document.getElementById('reply-' + inquiries.id);
                    const button = input.nextElementSibling;
                    if (detailRow.style.display === 'none') {
                        detailRow.style.display = 'table-row';
                        detailCommentRow.style.display = 'table-row';
                        input.style.display = 'inline-block';
                        button.style.display = 'inline-block';
                    } else {
                        detailRow.style.display = 'none';
                        detailCommentRow.style.display = 'none';
                        input.style.display = 'none';
                        button.style.display = 'none';
                    }
                });

                const detailRow = inquiriesTableBody.insertRow();
                detailRow.className = 'hidden-content';
                const detailStatusCell = detailRow.insertCell(0);
                const detailCell = detailRow.insertCell(1);
                const detailAuthorCell = detailRow.insertCell(2);
                const detailDateCell = detailRow.insertCell(3);

                detailCell.innerHTML += `${inquiries.content}`;
                if (currentUser && currentUser.id === inquiries.writerId) {
                    detailCell.innerHTML += `&nbsp;&nbsp;&nbsp;&nbsp;|
                                                <i class='fas fa-edit icon-button' onclick='openUpdateForm(${inquiries.id})'></i>
                                                <i class='fas fa-trash icon-button' onclick='deleteInquiry(${inquiries.id})'></i>
                                             `;
                }

                const detailCommentRow = inquiriesTableBody.insertRow();
                detailCommentRow.className = 'hidden-content';
                const detailCommentStatusCell = detailCommentRow.insertCell(0);
                const detailCommentCell = detailCommentRow.insertCell(1);
                const detailCommentAuthorCell = detailCommentRow.insertCell(2);
                const detailCommentDateCell = detailCommentRow.insertCell(3);

                if (inquiries.comment) {
                    detailCommentAuthorCell.textContent = inquiries.comment.writer;
                    detailCommentDateCell.textContent = new Date(inquiries.comment.createdAt).toLocaleDateString();
                    detailCommentCell.innerHTML += `└${inquiries.comment.comment}`;
                    if (currentUser && currentUser.id === inquiries.comment.writerId) {
                        detailCommentCell.innerHTML += `&nbsp;&nbsp;&nbsp;&nbsp;|
                                                        <i class='fas fa-edit icon-button' onclick='showEditDiv(${inquiries.comment.id})'></i>
                                                        <i class='fas fa-trash icon-button' onclick='deleteComment(${inquiries.comment.id})'></i>
                                                        <div style='display: none;' id='edit-${inquiries.comment.id}'>
                                                            <input type='text' id='comment-${inquiries.comment.id}' placeholder='Type your reply here...' class='reply-input' style='margin-top: 10px; width: 80%;'>
                                                            <button onclick='updateReply(${inquiries.comment.id})' class='btn-dark btn-reply' style='margin-left: 10px;'>답변 수정</button>
                                                        </div>
                        `;
                    }
                    detailCell.innerHTML += `<div style='display: none;'>
                                                <input type='text' id='reply-${inquiries.id}' placeholder='답변을 입력하세요.' class='reply-input'>
                                                <button onclick='submitReply(${inquiries.id})' class='btn-dark btn-reply' style='margin-left: 10px;'>답변 등록</button>
                                            </div>`;
                } else {
                    detailCell.innerHTML += `<div style='display: flex;'>
                                                <input type='text' id='reply-${inquiries.id}' placeholder='답변을 입력하세요.' class='reply-input'>
                                                <button onclick='submitReply(${inquiries.id})' class='btn-dark btn-reply' style='margin-left: 10px;'>답변 등록</button>
                                            </div>`;
                }
            })
        }
    }

    function openSubmitForm() {
        window.open(`/hotel/inquiries/submit/${hotelId}`, 'SubmitForm', 'width=500, height=700, resizable=yes, scrollbars=yes');
    }

    function openUpdateForm(id) {
        console.log(id);
        window.open(`/hotel/inquiries/update/${id}`, 'UpdateForm', 'width=500, height=700, resizable=yes, scrollbars=yes');
    }

    async function deleteInquiry(inquiryId) {
        const confirmed = confirm("삭제하시겠습니까?");
        if (confirmed) {
            const response = await fetch(`/api/hotel/inquiries/inquiry/${inquiryId}`, {
                method: 'DELETE'
            });
            if (response.ok) {
                alert("문의를 성공적으로 삭제하였습니다.");
                await fetchInquiries(); // Reload inquiries to reflect the change
            } else {
                alert("문의 삭제에 실패하였습니다.");
            }
        }
    }

    async function submitReply(inquiryId) {
        const replyText = document.getElementById('reply-' + inquiryId).value;
        if (replyText.trim() === '') {
            alert('Please type a reply.');
            return;
        }
        // Assuming you have an endpoint to handle POST requests for replies
        const response = await fetch(`/api/hotel/inquiries/comments/comment`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({inquiryId: inquiryId, comment: replyText}),
        });

        if (response.ok) {
            alert('답변이 정상적으로 등록되었습니다.');
            document.getElementById('reply-' + inquiryId).value = ''; // Clear input field
            location.reload();
        } else {
            alert('답변 등록에 실패하였습니다.');
        }
    }

    function showEditDiv(commentId) {
        const editDiv = document.getElementById(`edit-${commentId}`);
        editDiv.style.display = 'flex'; // 이 부분을 'flex'로 설정하여 보이게 합니다.
    }

    async function updateReply(commentId) {
        const replyInput = document.getElementById(`comment-${commentId}`);
        const commentContent = replyInput.value.trim();

        if (commentContent === '') {
            alert('답변 내용을 입력해주세요.');
            return;
        }

        const response = await fetch('/api/hotel/inquiries/comments/comment', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({id: commentId, comment: commentContent})
        });

        if (response.ok) {
            alert('답변이 성공적으로 수정되었습니다.');
            location.reload(); // 페이지를 새로고침하여 수정 사항 반영
        } else {
            throw new Error('답변 수정에 실패했습니다.');
        }

    }

    async function deleteComment(commentId) {
        const confirmed = confirm("답변을 삭제하시겠습니까?");
        if (confirmed) {
            const response = await fetch(`/api/hotel/inquiries/comments/comment/${commentId}`, {
                method: 'DELETE'
            });
            if (response.ok) {
                alert("답변이 성공적으로 삭제되었습니다..");
                await fetchInquiries(); // Reload inquiries to reflect the change
            } else {
                alert("답변 삭제에 실패하였습니다.");
            }
        }
    }


    function updatePaginationControls(inquiries) {
        const paginationArea = document.querySelector("#pagination");
        if (inquiries) {
            const {totalPages} = inquiries;
            const pageNumber = inquiries.pageable.pageNumber;  // 'pageNumber' 사용

            // 페이지네이션 버튼 동적 생성 및 이벤트 핸들러 할당
            paginationArea.innerHTML = `
            <button class="pagination-btn" onclick="fetchInquiries(${pageNumber - 1}, 10)" ${pageNumber === 0 ? 'disabled' : ''}><</button>
            <span id="totalPages">${pageNumber + 1} / ${totalPages}</span>
            <button class="pagination-btn" onclick="fetchInquiries(${pageNumber + 1}, 10)" ${pageNumber >= totalPages - 1 ? 'disabled' : ''}>></button>
        `;
        } else {
            paginationArea.innerHTML = "<span>페이지 정보를 사용할 수 없습니다.</span>";  // 잘못되거나 누락된 페이지네이션 데이터 처리
            console.error("Pagination data is missing or incorrect");
        }
    }

    function updateTable(inquiries) {
        const inquiriesTableBody = document.querySelector('#inquiries tbody');
        inquiriesTableBody.innerHTML = ''; // Clear existing entries
        inquiries.content.forEach(inquiry => {
            // Append new rows to the table as done previously
        });
    }

    // 윈도우 로드 후 실행할 함수들
    window.onload = async function () {
        await fetchHotelInfo();
        fetchReviews();
        loadTourInfo();
        fillSearchParams();
        // 문의
        fetchInquiries();
    }

</script>
</body>
</html>